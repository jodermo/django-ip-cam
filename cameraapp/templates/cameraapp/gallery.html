{% extends "base.html" %}
{% block content %}
    <h2 style="text-align:center;">Timelaps Gallery</h2>
    <canvas id="photoCanvas" width="640" height="480"></canvas>

    <div class="controls">
        <button onclick="prevImage()">Previous</button>
        <button onclick="togglePlayPause()" id="playPauseBtn">Play</button>
        <button onclick="nextImage()">Next</button>
    </div>

    <div class="slider-container">
        <label>Interval (ms): <span id="speedValue">3000</span></label><br>
        <input type="range" id="speedRange" min="25" max="1000" step="25" value="3000" onchange="updateSpeed()">
    </div>

    <div class="slider-container">
        <label>Duration (sec): <span id="durationValue">30</span></label><br>
        <input type="range" id="durationRange" min="5" max="300" step="5" value="30" onchange="updateDuration()">
    </div>

    <div class="slider-container">
        <label>Timeline: <span id="currentIndex">0</span> / <span id="totalCount">0</span></label><br>
        <input type="range" id="timeSlider" min="0" value="0" onchange="sliderJump()">
    </div>
    <div id="thumbnailBar" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; max-height: 120px; overflow-y: auto;">
        {% for photo in photos %}
            <img src="{{ photo }}" width="80" style="cursor: pointer;" onclick="jumpToIndex({{ forloop.counter0 }})">
        {% endfor %}
    </div>
    <hr>


    <h1>Foto-Einstellungen</h1>
    
    <form method="post" action="{% url 'update_photo_settings' %}">
      {% csrf_token %}
    
      <label>Brightness:
        <input type="range" step="0.1" name="photo_brightness" value="{{ settings.photo_brightness }}">
      </label><br>
    
      <label>Contrast:
        <input type="range" step="0.1" name="photo_contrast" value="{{ settings.photo_contrast }}">
      </label><br>
    
      <label>Saturation:
        <input type="range" step="0.1" name="photo_saturation" value="{{ settings.photo_saturation }}">
      </label><br>
    
      <label>Exposure:
        <input type="range" step="0.1" name="photo_exposure" value="{{ settings.photo_exposure }}">
      </label><br>
    
      <label>Gain:
        <input type="range" step="0.1" name="photo_gain" value="{{ settings.photo_gain }}">
      </label><br>
    
      <label>Exposure Mode:
        <select name="photo_exposure_mode">
          <option value="manual" {% if settings.photo_exposure_mode == 'manual' %}selected{% endif %}>Manuell</option>
          <option value="auto" {% if settings.photo_exposure_mode == 'auto' %}selected{% endif %}>Auto</option>
        </select>
      </label><br>
    
      <button type="submit">Speichern</button>
    </form>

    <form method="post" action="{% url 'reset_camera' %}">
        {% csrf_token %}
        <button type="submit">🔄 Kamera zurücksetzen</button>
    </form>
    
    <button onclick="takePhoto()" style="margin-top: 10px;">📷 Manuelles Foto aufnehmen</button>


    <button onclick="autoAdjust()">
        🌞 Auto-Anpassen vom Livebild
    </button>


    <script>
        const photos = {{ photos|safe }};
        let index = 0;
        let playing = false;
        let intervalId = null;
        let stopTimeoutId = null;
        let intervalMs = 3000;
        let durationSec = 30;

        const canvas = document.getElementById("photoCanvas");
        const ctx = canvas.getContext("2d");

        const speedSlider = document.getElementById("speedRange");
        const speedLabel = document.getElementById("speedValue");

        const durationSlider = document.getElementById("durationRange");
        const durationLabel = document.getElementById("durationValue");

        const timeSlider = document.getElementById("timeSlider");
        const currentIndexLabel = document.getElementById("currentIndex");
        const totalCountLabel = document.getElementById("totalCount");

        totalCountLabel.textContent = photos.length - 1;
        timeSlider.max = photos.length - 1;

        function jumpToIndex(i) {
            showImage(i);
        }
        function autoAdjust(){
            fetch("{% url 'auto_photo_adjust' %}", {
                method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            }).then(r => r.json()).then(data => {
                alert(data.status);
                location.reload();
            })
        }
        function takePhoto() {
            fetch("{% url 'take_photo_now' %}", {
                method: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status || "Foto aufgenommen");
                location.reload();
            })
            .catch(err => alert("Fehler beim Auslösen: " + err));
        }

        function applyAutoPhotoSettings() {
            fetch("{% url 'auto_photo_settings' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                }
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        }

        function loadImage(src) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const match = src.match(/photo_(\d{8}_\d{6})/);
                if (match) {
                    const raw = match[1]; // z. B. 20250426_101234
                    const year = raw.slice(0, 4);
                    const month = raw.slice(4, 6);
                    const day = raw.slice(6, 8);
                    const hour = raw.slice(9, 11);
                    const minute = raw.slice(11, 13);
                    const second = raw.slice(13, 15);

                    // Erzeuge echte JS-Zeit in der lokalen Zeitzone
                    const localDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`);

                    const timestamp = `⏱ ${localDate.toLocaleDateString()} ${localDate.toLocaleTimeString()}`;


                    ctx.font = "18px monospace";
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillRect(0, 0, canvas.width, 30);
                    ctx.fillStyle = "white";
                    ctx.fillText(timestamp, 10, 22);
                }

            };
            img.src = src;
        }

        function showImage(i) {
            if (photos.length > 0) {
                index = (i + photos.length) % photos.length;
                loadImage(photos[index]);
                timeSlider.value = index;
                currentIndexLabel.textContent = index;
            }
            document.querySelectorAll("#thumbnailBar img").forEach((img, i) => {
                img.classList.toggle("selected", i === index);
            });
        }

        function nextImage() {
            showImage(index + 1);
        }

        function prevImage() {
            showImage(index - 1);
        }

        function togglePlayPause() {
            playing = !playing;
            document.getElementById("playPauseBtn").textContent = playing ? "Pause" : "Play";

            if (playing) {
                intervalId = setInterval(nextImage, intervalMs);
                stopTimeoutId = setTimeout(() => togglePlayPause(), durationSec * 1000);
            } else {
                clearInterval(intervalId);
                clearTimeout(stopTimeoutId);
            }
        }

        function updateSpeed() {
            intervalMs = parseInt(speedSlider.value);
            speedLabel.textContent = intervalMs;

            if (playing) {
                clearInterval(intervalId);
                intervalId = setInterval(nextImage, intervalMs);
            }
        }

        function updateDuration() {
            durationSec = parseInt(durationSlider.value);
            durationLabel.textContent = durationSec;
        }

        function sliderJump() {
            const target = parseInt(timeSlider.value);
            showImage(target);
        }

        // Initiales Bild laden
        if (photos.length > 0) {
            showImage(0);
        }
    </script>
{% endblock %}