<!DOCTYPE html>
<html>
<head>
    <title>Photo Gallery</title>
    <style>
        canvas {
            border: 2px solid #333;
            display: block;
            margin: 20px auto;
        }
        .controls {
            text-align: center;
            margin-bottom: 10px;
        }
        button {
            margin: 5px;
        }
        .slider-container {
            text-align: center;
            margin-top: 10px;
        }
        label {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Saved Photos</h2>
    <canvas id="photoCanvas" width="640" height="480"></canvas>

    <div class="controls">
        <button onclick="prevImage()">Previous</button>
        <button onclick="togglePlayPause()" id="playPauseBtn">Play</button>
        <button onclick="nextImage()">Next</button>
    </div>

    <div class="slider-container">
        <label>Interval (ms): <span id="speedValue">3000</span></label><br>
        <input type="range" id="speedRange" min="25" max="10000" step="25" value="3000" onchange="updateSpeed()">
    </div>

    <div class="slider-container">
        <label>Duration (sec): <span id="durationValue">30</span></label><br>
        <input type="range" id="durationRange" min="5" max="300" step="5" value="30" onchange="updateDuration()">
    </div>

    <div class="slider-container">
        <label>Timeline: <span id="currentIndex">0</span> / <span id="totalCount">0</span></label><br>
        <input type="range" id="timeSlider" min="0" value="0" onchange="sliderJump()">
    </div>

    <script>
        const photos = {{ photos|safe }};
        let index = 0;
        let playing = false;
        let intervalId = null;
        let stopTimeoutId = null;
        let intervalMs = 3000;
        let durationSec = 30;

        const canvas = document.getElementById("photoCanvas");
        const ctx = canvas.getContext("2d");

        const speedSlider = document.getElementById("speedRange");
        const speedLabel = document.getElementById("speedValue");

        const durationSlider = document.getElementById("durationRange");
        const durationLabel = document.getElementById("durationValue");

        const timeSlider = document.getElementById("timeSlider");
        const currentIndexLabel = document.getElementById("currentIndex");
        const totalCountLabel = document.getElementById("totalCount");

        totalCountLabel.textContent = photos.length - 1;
        timeSlider.max = photos.length - 1;

        function loadImage(src) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const match = src.match(/photo_(\d{8}_\d{6})/);
                if (match) {
                    const rawTimestamp = match[1];
                    const formatted = rawTimestamp.replace("_", " ").replace(/(\d{4})(\d{2})(\d{2})/, "$3.$2.$1");
                    const timestamp = "⏱ " + formatted;

                    ctx.font = "18px monospace";
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillRect(0, 0, canvas.width, 30);
                    ctx.fillStyle = "white";
                    ctx.fillText(timestamp, 10, 22);
                }
            };
            img.src = src;
        }

        function showImage(i) {
            if (photos.length > 0) {
                index = (i + photos.length) % photos.length;
                loadImage(photos[index]);
                timeSlider.value = index;
                currentIndexLabel.textContent = index;
            }
        }

        function nextImage() {
            showImage(index + 1);
        }

        function prevImage() {
            showImage(index - 1);
        }

        function togglePlayPause() {
            playing = !playing;
            document.getElementById("playPauseBtn").textContent = playing ? "Pause" : "Play";

            if (playing) {
                intervalId = setInterval(nextImage, intervalMs);
                stopTimeoutId = setTimeout(() => togglePlayPause(), durationSec * 1000);
            } else {
                clearInterval(intervalId);
                clearTimeout(stopTimeoutId);
            }
        }

        function updateSpeed() {
            intervalMs = parseInt(speedSlider.value);
            speedLabel.textContent = intervalMs;

            if (playing) {
                clearInterval(intervalId);
                intervalId = setInterval(nextImage, intervalMs);
            }
        }

        function updateDuration() {
            durationSec = parseInt(durationSlider.value);
            durationLabel.textContent = durationSec;
        }

        function sliderJump() {
            const target = parseInt(timeSlider.value);
            showImage(target);
        }

        // Initiales Bild laden
        if (photos.length > 0) {
            showImage(0);
        }
    </script>
</body>
</html>
