{% extends "base.html" %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">

<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden; background: black;
  }
  #galleryContainer {
    position: relative; width: 100vw; height: 100vh; background: black;
  }
  #photoCanvas {
    width: 100%; height: 100%; object-fit: contain; background: black; display: block;
  }

  .overlay-controls {
    position: absolute; top: 10px; left: 10px; z-index: 10;
    background: rgba(0,0,0,0.6); padding: 1em; border-radius: 8px; color: #fff;
  }
  .overlay-controls button {
    margin: 0.3em; padding: 0.4em 0.8em; background: #1e90ff; color: #fff;
    border: none; border-radius: 5px; cursor: pointer;
  }
  .overlay-controls button:hover { background: #3aa0ff; }

  /* Settings popup */
  .settings-popup {
    position: absolute; top: 160px; left: 10px; width: 250px;
    background: rgba(20,20,20,0.95); padding: 1em; border-radius: 8px;
    color: #fff; display: none; z-index: 20;
  }
  .settings-popup input[type=range] { width: 100%; }
  .settings-popup select, .settings-popup button { margin-top: 0.5em; }

  /* Carousel wrapper */
  #thumbnailWrapper {
    position: absolute; bottom: 10px; left: 10px; right: 10px; height: 100px;
    z-index: 15; overflow: hidden;
  }
  #thumbnailBar {
    display: flex; gap: 8px; height: 100%; padding: 8px 40px;
    background: rgba(0,0,0,0.6); border-radius: 6px;
    overflow-x: auto; scroll-behavior: smooth;
  }
  .thumb-container {
    position: relative; scroll-snap-align: start;
  }
  .thumb-container img {
    border-radius: 4px; cursor: pointer; transition: transform .2s ease;
  }
  .thumb-container img:hover { transform: scale(1.05); }
  .thumb-container img.selected { outline: 3px solid yellow; }

  .thumb-tooltip {
    position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: #fff; padding: 4px 8px;
    border-radius: 4px; white-space: nowrap; font-size: .8em;
    display: none;
  }
  .thumb-container:hover .thumb-tooltip { display: block; }

  /* Prev/Next arrows for carousel */
  .carousel-btn {
    position: absolute; top: calc(100% - 50px); width: 30px; height: 30px;
    background: rgba(30,144,255,0.8); color: #fff; border: none;
    border-radius: 50%; cursor: pointer; font-size: 1.2em;
    display: flex; align-items: center; justify-content: center;
  }
  #thumbPrev { left: 10px; }
  #thumbNext { right: 10px; }
  .carousel-btn:hover { background: rgba(58,160,255,0.9); }
</style>

<div id="galleryContainer">
  <canvas id="photoCanvas" width="640" height="480"></canvas>

  <div class="overlay-controls">
    <button onclick="prevImage()">‚è™ Prev</button>
    <button onclick="togglePlayPause()" id="playPauseBtn">‚ñ∂Ô∏è Play</button>
    <button onclick="nextImage()">‚è© Next</button>
    <button onclick="autoAdjust()">üåû Auto Adjust</button>
    <button onclick="takePhoto()">üì∑ Take Photo</button>
    <button onclick="toggleSettings()">‚öôÔ∏è Settings</button>
    <form method="post" action="{% url 'reset_camera' %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit">üîÑ Reset</button>
    </form>
  </div>

  <div class="settings-popup" id="settingsPopup">
    <form method="post" action="{% url 'update_photo_settings' %}">
      {% csrf_token %}
      <label>Brightness:</label>
      <input type="range" name="photo_brightness" min="0" max="255" step="0.1"
             value="{{ settings.photo_brightness }}"><br>
      <label>Contrast:</label>
      <input type="range" name="photo_contrast" min="0" max="255" step="0.1"
             value="{{ settings.photo_contrast }}"><br>
      <label>Saturation:</label>
      <input type="range" name="photo_saturation" min="0" max="255" step="0.1"
             value="{{ settings.photo_saturation }}"><br>
      <label>Exposure (-13 to 0):</label>
      <input type="range" name="photo_exposure" min="-13" max="0" step="0.1"
             value="{{ settings.photo_exposure }}"><br>
      <label>Gain (0‚Äì10):</label>
      <input type="range" name="photo_gain" min="0" max="10" step="0.1"
             value="{{ settings.photo_gain }}"><br>
      <label>Exposure Mode:</label>
      <select name="photo_exposure_mode">
        <option value="manual" {% if settings.photo_exposure_mode=='manual' %}selected{% endif %}>Manual</option>
        <option value="auto"   {% if settings.photo_exposure_mode=='auto'   %}selected{% endif %}>Auto</option>
      </select><br>
      <label>Play Speed (ms):</label>
      <input type="range" id="speedRange" min="100" max="3000" step="100"
             value="1000" oninput="updateSpeed(this.value)">
      <span id="speedLabel">1000</span><br>
      <label>Max Play Duration (sec):</label>
      <input type="range" id="durationRange" min="5" max="300" step="5"
             value="30" oninput="updateDuration(this.value)">
      <span id="durationLabel">30</span><br>
      <button type="submit">‚úÖ Apply</button>
    </form>
  </div>

  <!-- Carousel -->
  <div id="thumbnailWrapper">
    <button id="thumbPrev" class="carousel-btn" onclick="scrollThumbnails(-200)">‚Äπ</button>
    <div id="thumbnailBar">
      {% for photo in photos %}
        {% with raw=photo|slice:"-19:-4" %}
          {% with
            year=raw|slice:":4"
            month=raw|slice:"4:6"
            day=raw|slice:"6:8"
            hour=raw|slice:"9:11"
            minute=raw|slice:"11:13"
            second=raw|slice:"13:15"
          %}
            {% with timestr=day|add:"/"|add:month|add:"/"|add:year
               |add:" "|add:hour|add:":"|add:minute|add:":"|add:second %}
              <div class="thumb-container">
                <img src="{{ photo }}"
                     width="80"
                     onclick="jumpToIndex({{ forloop.counter0 }})"
                     class="{% if forloop.first %}selected{% endif %}">
                <div class="thumb-tooltip">{{ timestr }}</div>
              </div>
            {% endwith %}
          {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>
    <button id="thumbNext" class="carousel-btn" onclick="scrollThumbnails(200)">‚Ä∫</button>
  </div>
</div>

<script>
  const photos = {{ photos|safe }};
  const thumbBar = document.getElementById("thumbnailBar");
  let index = 0, playing = false, intervalId, stopTimeoutId;
  let intervalMs = 1000, durationSec = 30;

  const canvas = document.getElementById("photoCanvas");
  const ctx = canvas.getContext("2d");

  function loadImage(src) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = src;
  }

  function showImage(i) {
    if (!photos.length) return;
    index = (i + photos.length) % photos.length;
    loadImage(photos[index]);
    document.querySelectorAll(".thumb-container img")
      .forEach((el, idx) => el.classList.toggle("selected", idx===index));
  }

  function nextImage() { showImage(index+1); }
  function prevImage() { showImage(index-1); }
  function jumpToIndex(i) { showImage(i); }

  function togglePlayPause() {
    playing = !playing;
    document.getElementById("playPauseBtn").textContent =
      playing ? "‚è∏ Pause" : "‚ñ∂Ô∏è Play";
    if (playing) {
      intervalId = setInterval(nextImage, intervalMs);
      stopTimeoutId = setTimeout(togglePlayPause, durationSec*1000);
    } else {
      clearInterval(intervalId);
      clearTimeout(stopTimeoutId);
    }
  }

  function scrollThumbnails(px) {
    thumbBar.scrollBy({ left: px, behavior: 'smooth' });
  }

  function toggleSettings() {
    const pop = document.getElementById("settingsPopup");
    pop.style.display = pop.style.display==='block'?'none':'block';
  }
  function updateSpeed(v) {
    intervalMs = +v; document.getElementById("speedLabel").textContent = v;
    if (playing) { clearInterval(intervalId); intervalId = setInterval(nextImage, intervalMs); }
  }
  function updateDuration(v) {
    durationSec = +v; document.getElementById("durationLabel").textContent = v;
  }

  function autoAdjust(){
    fetch("{% url 'auto_photo_adjust' %}",{
      method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}
    }).then(r=>r.json()).then(d=>alert(d.status)).finally(()=>location.reload());
  }
  function takePhoto(){
    fetch("{% url 'take_photo_now' %}",{
      method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}
    }).then(r=>r.json()).then(d=>alert(d.status||'Photo taken')).finally(()=>location.reload());
  }

  if (photos.length) showImage(0);
</script>
{% endblock %}
