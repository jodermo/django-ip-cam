{% extends "base.html" %}
{% block content %}
    <h2 style="text-align:center;">Timelaps Gallery</h2>
    <canvas id="photoCanvas" width="640" height="480"></canvas>

    <div class="controls">
        <button onclick="prevImage()">Previous</button>
        <button onclick="togglePlayPause()" id="playPauseBtn">Play</button>
        <button onclick="nextImage()">Next</button>
    </div>

    <div class="slider-container">
        <label>Interval (ms): <span id="speedValue">3000</span></label><br>
        <input type="range" id="speedRange" min="25" max="10000" step="25" value="3000" onchange="updateSpeed()">
    </div>

    <div class="slider-container">
        <label>Duration (sec): <span id="durationValue">30</span></label><br>
        <input type="range" id="durationRange" min="5" max="300" step="5" value="30" onchange="updateDuration()">
    </div>

    <div class="slider-container">
        <label>Timeline: <span id="currentIndex">0</span> / <span id="totalCount">0</span></label><br>
        <input type="range" id="timeSlider" min="0" value="0" onchange="sliderJump()">
    </div>
    <div id="thumbnailBar" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; max-height: 120px; overflow-y: auto;">
        {% for photo in photos %}
            <img src="{{ photo }}" width="80" style="cursor: pointer;" onclick="jumpToIndex({{ forloop.counter0 }})">
        {% endfor %}
    </div>
    <hr>
<form method="post" id="photoSettingsForm" action="{% url 'update_photo_settings' %}">
    {% csrf_token %}
    <fieldset>
        <legend>Foto-Kameraeinstellungen</legend>
        <label>Helligkeit:</label>
        <input type="number" step="0.1" name="photo_brightness" value="{{ settings.photo_brightness }}"><br>

        <label>Kontrast:</label>
        <input type="number" step="0.1" name="photo_contrast" value="{{ settings.photo_contrast }}"><br>

        <label>Sättigung:</label>
        <input type="number" step="0.1" name="photo_saturation" value="{{ settings.photo_saturation }}"><br>

        <label>Belichtung:</label>
        <input type="number" step="0.1" name="photo_exposure" value="{{ settings.photo_exposure }}"><br>

        <label>Gain:</label>
        <input type="number" step="0.1" name="photo_gain" value="{{ settings.photo_gain }}"><br>

        <button type="submit">Speichern</button>
    </fieldset>
</form>

<button onclick="takePhoto()" style="margin-top: 10px;">📷 Manuelles Foto aufnehmen</button>

    <script>
        const photos = {{ photos|safe }};
        let index = 0;
        let playing = false;
        let intervalId = null;
        let stopTimeoutId = null;
        let intervalMs = 3000;
        let durationSec = 30;

        const canvas = document.getElementById("photoCanvas");
        const ctx = canvas.getContext("2d");

        const speedSlider = document.getElementById("speedRange");
        const speedLabel = document.getElementById("speedValue");

        const durationSlider = document.getElementById("durationRange");
        const durationLabel = document.getElementById("durationValue");

        const timeSlider = document.getElementById("timeSlider");
        const currentIndexLabel = document.getElementById("currentIndex");
        const totalCountLabel = document.getElementById("totalCount");

        totalCountLabel.textContent = photos.length - 1;
        timeSlider.max = photos.length - 1;

        function jumpToIndex(i) {
            showImage(i);
        }
        function takePhoto() {
            fetch("{% url 'take_photo_now' %}", {
                method: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => response.json())
            .then(data => alert(data.status || "Foto aufgenommen"))
            .catch(err => alert("Fehler beim Auslösen: " + err));
        }
        function loadImage(src) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const match = src.match(/photo_(\d{8}_\d{6})/);
                if (match) {
                    const rawTimestamp = match[1];
                    const datePart = rawTimestamp.slice(0, 8);
                    const timePart = rawTimestamp.slice(9, 15);
                    const formattedDate = `${datePart.slice(6, 8)}.${datePart.slice(4, 6)}.${datePart.slice(0, 4)}`;
                    const formattedTime = `${timePart.slice(0, 2)}:${timePart.slice(2, 4)}:${timePart.slice(4, 6)}`;
                    const timestamp = `⏱ ${formattedDate} ${formattedTime}`;

                    ctx.font = "18px monospace";
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillRect(0, 0, canvas.width, 30);
                    ctx.fillStyle = "white";
                    ctx.fillText(timestamp, 10, 22);
                }

            };
            img.src = src;
        }

        function showImage(i) {
            if (photos.length > 0) {
                index = (i + photos.length) % photos.length;
                loadImage(photos[index]);
                timeSlider.value = index;
                currentIndexLabel.textContent = index;
            }
            document.querySelectorAll("#thumbnailBar img").forEach((img, i) => {
                img.classList.toggle("selected", i === index);
            });
        }

        function nextImage() {
            showImage(index + 1);
        }

        function prevImage() {
            showImage(index - 1);
        }

        function togglePlayPause() {
            playing = !playing;
            document.getElementById("playPauseBtn").textContent = playing ? "Pause" : "Play";

            if (playing) {
                intervalId = setInterval(nextImage, intervalMs);
                stopTimeoutId = setTimeout(() => togglePlayPause(), durationSec * 1000);
            } else {
                clearInterval(intervalId);
                clearTimeout(stopTimeoutId);
            }
        }

        function updateSpeed() {
            intervalMs = parseInt(speedSlider.value);
            speedLabel.textContent = intervalMs;

            if (playing) {
                clearInterval(intervalId);
                intervalId = setInterval(nextImage, intervalMs);
            }
        }

        function updateDuration() {
            durationSec = parseInt(durationSlider.value);
            durationLabel.textContent = durationSec;
        }

        function sliderJump() {
            const target = parseInt(timeSlider.value);
            showImage(target);
        }

        // Initiales Bild laden
        if (photos.length > 0) {
            showImage(0);
        }
    </script>
{% endblock %}