{% extends "base.html" %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<h1>Live Kamera</h1>
<p>Angemeldet als: {{ request.user.username }}</p>
<p><a href="{% url 'logout' %}">Logout</a></p>


{% if camera_error %}
    <p style="color: red;">Error: {{ camera_error }}</p>
{% else %}
    <p><strong>Aktive Zuschauer:</strong> {{ viewer_count }}</p>
    <img src="{% url 'video_feed' %}" width="640" height="480" alt="Live Stream">
    <div style="margin-top:10px;">
        <button onclick="startRecording()">Start Recording</button>
        <button onclick="stopRecording()">Stop Recording</button>
    </div>
    <p id="recordStatus" style="font-weight: bold;"></p>

    <form method="POST" action="{% url 'update_camera_settings' %}" style="margin-top: 20px;">
        {% csrf_token %}
        <fieldset>
            <legend>Kameraeinstellungen (Video)</legend>
    
            <label>Helligkeit: <span id="video_brightness_val">{{ settings.video_brightness }}</span></label><br>
            <input type="range" min="0" max="1" step="0.01" name="brightness"
                   value="{{ settings.video_brightness }}" oninput="video_brightness_val.innerText = this.value"><br>
    
            <label>Kontrast: <span id="video_contrast_val">{{ settings.video_contrast }}</span></label><br>
            <input type="range" min="0" max="1" step="0.01" name="contrast"
                   value="{{ settings.video_contrast }}" oninput="video_contrast_val.innerText = this.value"><br>
    
            <label>Sättigung: <span id="video_saturation_val">{{ settings.video_saturation }}</span></label><br>
            <input type="range" min="0" max="1" step="0.01" name="saturation"
                   value="{{ settings.video_saturation }}" oninput="video_saturation_val.innerText = this.value"><br>
    
            <label>Belichtung: <span id="video_exposure_val">{{ settings.video_exposure }}</span></label><br>
            <input type="range" min="-10" max="10" step="0.1" name="exposure"
                   value="{{ settings.video_exposure }}" oninput="video_exposure_val.innerText = this.value"><br>
    
            <label>Gain: <span id="video_gain_val">{{ settings.video_gain }}</span></label><br>
            <input type="range" min="0" max="1" step="0.01" name="gain"
                   value="{{ settings.video_gain }}" oninput="video_gain_val.innerText = this.value"><br>
    
            <button type="submit" style="margin-top:10px;">Übernehmen</button>
        </fieldset>
    </form>
    
    
    <button onclick="autoAdjust()">
        🌞 Auto-Anpassen vom Livebild
    </button>


{% endif %}

<script>

function updateRecordingStatus() {
    fetch("{% url 'is_recording' %}")
        .then(response => {
            if (!response.ok) throw new Error(`Status ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("[is_recording] response", data);
            const el = document.getElementById("recordStatus");
            el.innerText = data.recording ? "● Recording in progress" : "Not recording";
            el.style.color = data.recording ? "red" : "black";
        })
        .catch(err => {
            console.error("[is_recording] error", err);
        });
}



setInterval(updateRecordingStatus, 3000);
updateRecordingStatus();
function autoAdjust(){
    fetch("{% url 'auto_photo_adjust' %}", {
        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => r.json()).then(data => {
        alert(data.status);
        location.reload();
    })
}
function startRecording() {
    fetch("{% url 'start_recording' %}", {
    method: "POST",
    headers: {'X-CSRFToken': '{{ csrf_token }}'}
})
.then(response => response.json())
.then(data => {
    console.log("Start Recording Response:", data);
    updateRecordingStatus();
});
}

function stopRecording() {
    fetch("{% url 'stop_recording' %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    }).then(() => updateRecordingStatus());
}
</script>

{% endblock %}
