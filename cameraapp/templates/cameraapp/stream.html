{% extends "base.html" %}
{% block content %}

<h1>Live Kamera</h1>
<p>Angemeldet als: {{ request.user.username }}</p>
<p><a href="{% url 'logout' %}">Logout</a></p>
<meta name="csrf-token" content="{{ csrf_token }}">

{% if camera_error %}
    <p style="color: red;">Error: {{ camera_error }}</p>
{% else %}
    <p><strong>Aktive Zuschauer:</strong> {{ viewer_count }}</p>
    <img src="{% url 'video_feed' %}" width="640" height="480" alt="Live Stream">
    <div style="margin-top:10px;">
        <button onclick="startRecording()">Start Recording</button>
        <button onclick="stopRecording()">Stop Recording</button>
    </div>
    <p id="recordStatus" style="font-weight: bold;"></p>
{% endif %}

<script>
function updateRecordingStatus() {
    fetch("{% url 'is_recording' %}")
        .then(response => response.json())
        .then(data => {
            const el = document.getElementById("recordStatus");
            if (data.recording) {
                el.innerText = "● Recording in progress";
                el.style.color = "red";
            } else {
                el.innerText = "Not recording";
                el.style.color = "black";
            }
        });
}

setInterval(updateRecordingStatus, 3000);
updateRecordingStatus();

function startRecording() {
    fetch("{% url 'start_recording' %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    }).then(() => updateRecordingStatus());
}

function stopRecording() {
    fetch("{% url 'stop_recording' %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    }).then(() => updateRecordingStatus());
}
</script>

{% endblock %}
